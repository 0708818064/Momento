{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ "Admin Login" if admin_login else "Login" }}</h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">
                        {{ message }}
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <div id="biometric-messages"></div>

                    <form method="POST" action="{{ url_for('auth.login') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="admin_login" value="{{ '1' if admin_login else '0' }}">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                {{ "Admin Login" if admin_login else "Login" }}
                            </button>
                            {% if not admin_login %}
                            <button type="button" id="biometricLoginBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-fingerprint"></i> Login with Passkey
                            </button>
                            {% endif %}
                        </div>
                    </form>

                    {% if not admin_login %}
                    <div class="mt-3 text-center">
                        <p>Don't have an account? <a href="{{ url_for('auth.register') }}">Register here</a></p>
                        <p>Forgot your password? <a href="{{ url_for('auth.forgot_password') }}">Reset it here</a></p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showBiometricMessage(message, type) {
        const messagesDiv = document.getElementById('biometric-messages');
        messagesDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    function base64urlToBuffer(base64url) {
        const padding = '='.repeat((4 - base64url.length % 4) % 4);
        const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray.buffer;
    }

    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let str = '';
        for (const byte of bytes) {
            str += String.fromCharCode(byte);
        }
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    const biometricLoginBtn = document.getElementById('biometricLoginBtn');
    if (biometricLoginBtn) {
        biometricLoginBtn.addEventListener('click', async () => {
            const username = document.getElementById('username').value;

            if (!username) {
                showBiometricMessage('Please enter your username first.', 'warning');
                return;
            }

            try {
                biometricLoginBtn.disabled = true;
                biometricLoginBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Authenticating...';

                // Get authentication options
                const optionsRes = await fetch('/biometric/login-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const options = await optionsRes.json();

                if (options.error) {
                    throw new Error(options.error);
                }

                // Convert base64url to ArrayBuffer
                options.challenge = base64urlToBuffer(options.challenge);
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    }));
                }

                // Get credential
                const credential = await navigator.credentials.get({
                    publicKey: options
                });

                // Prepare for server
                const credentialData = {
                    id: credential.id,
                    rawId: bufferToBase64url(credential.rawId),
                    type: credential.type,
                    response: {
                        authenticatorData: bufferToBase64url(credential.response.authenticatorData),
                        clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                        signature: bufferToBase64url(credential.response.signature),
                        userHandle: credential.response.userHandle ? bufferToBase64url(credential.response.userHandle) : null,
                    }
                };

                // Verify with server
                const verifyRes = await fetch('/biometric/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentialData)
                });

                const result = await verifyRes.json();

                if (result.success) {
                    showBiometricMessage(result.message, 'success');
                    window.location.href = result.redirect;
                } else {
                    throw new Error(result.error || 'Authentication failed');
                }

            } catch (error) {
                console.error('Biometric login error:', error);
                showBiometricMessage('Error: ' + error.message, 'danger');
                biometricLoginBtn.disabled = false;
                biometricLoginBtn.innerHTML = '<i class="bi bi-fingerprint"></i> Login with Passkey';
            }
        });
    }
</script>
{% endblock %}