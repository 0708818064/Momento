{% extends "base.html" %}
{% block title %}Slider Puzzle - {{ challenge.id }}{% endblock %}

{% block extra_css %}
<style>
    .puzzle-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        width: 300px;
        height: 300px;
        margin: 0 auto;
        background: var(--bg-tertiary);
        padding: 10px;
        border-radius: 1rem;
    }

    .puzzle-tile {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        background: linear-gradient(135deg, var(--accent-primary), #4f46e5);
        color: white;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }

    .puzzle-tile:hover:not(.empty) {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .puzzle-tile.empty {
        background: transparent;
        cursor: default;
    }

    .move-counter {
        font-size: 1.5rem;
        color: var(--accent-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-puzzle-piece me-2" style="color: #e879f9;"></i>
                Slider Puzzle
            </h2>
            <p class="text-muted mb-0">Arrange tiles in order (1-8) to reveal key characters</p>
        </div>
        <a href="{{ url_for('minigames.minigames_hub', challenge_id=challenge.id) }}" class="btn btn-outline-custom">
            <i class="fas fa-arrow-left me-1"></i>Back
        </a>
    </div>

    <div class="card-dark">
        <div class="card-body py-4 text-center">
            <div class="mb-3">
                <span class="text-muted">Moves:</span>
                <span class="move-counter" id="moveCount">0</span>
            </div>

            <div class="puzzle-container" id="puzzle">
                <!-- Tiles will be generated by JS -->
            </div>

            <div class="mt-4">
                <button class="btn btn-outline-custom" onclick="shufflePuzzle()">
                    <i class="fas fa-random me-2"></i>Shuffle
                </button>
            </div>

            <!-- Result -->
            <div id="resultArea" style="display: none;" class="mt-4">
                <div class="alert py-4"
                    style="background: rgba(16, 185, 129, 0.15); border: 2px solid var(--accent-success); border-radius: 1rem;">
                    <h4 class="mb-3 text-success"><i class="fas fa-check-circle me-2"></i>ðŸŽ‰ Puzzle Solved!</h4>
                    <p class="text-muted mb-2">You've revealed a key part:</p>
                    <div class="p-3 mb-3"
                        style="background: var(--bg-primary); border-radius: 0.5rem; border: 1px solid var(--accent-success);">
                        <span class="text-muted small">KEY PART:</span>
                        <div style="font-size: 2.5rem; font-family: 'Courier New', monospace; color: var(--accent-success); text-shadow: 0 0 15px rgba(16, 185, 129, 0.5);"
                            id="revealedPart"></div>
                    </div>
                    <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>This part has been added to
                        your key progress!</p>
                </div>
                <a href="{{ url_for('minigames.minigames_hub', challenge_id=challenge.id) }}"
                    class="btn btn-success btn-lg mt-3">
                    <i class="fas fa-arrow-right me-2"></i>Continue to Hub
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let puzzleState = {{ puzzle | tojson }};
    let moves = 0;

    function renderPuzzle() {
        const container = document.getElementById('puzzle');
        container.innerHTML = '';

        puzzleState.forEach((value, index) => {
            const tile = document.createElement('div');
            tile.className = 'puzzle-tile' + (value === 0 ? ' empty' : '');
            tile.textContent = value === 0 ? '' : value;
            tile.dataset.index = index;
            tile.onclick = () => moveTile(index);
            container.appendChild(tile);
        });
    }

    function moveTile(index) {
        const emptyIndex = puzzleState.indexOf(0);
        const validMoves = getValidMoves(emptyIndex);

        if (validMoves.includes(index)) {
            // Swap tiles
            [puzzleState[index], puzzleState[emptyIndex]] = [puzzleState[emptyIndex], puzzleState[index]];
            moves++;
            document.getElementById('moveCount').textContent = moves;
            renderPuzzle();

            if (checkSolved()) {
                setTimeout(completePuzzle, 500);
            }
        }
    }

    function getValidMoves(emptyIndex) {
        const moves = [];
        const row = Math.floor(emptyIndex / 3);
        const col = emptyIndex % 3;

        if (row > 0) moves.push(emptyIndex - 3); // Up
        if (row < 2) moves.push(emptyIndex + 3); // Down
        if (col > 0) moves.push(emptyIndex - 1); // Left
        if (col < 2) moves.push(emptyIndex + 1); // Right

        return moves;
    }

    function checkSolved() {
        const solution = [1, 2, 3, 4, 5, 6, 7, 8, 0];
        return puzzleState.every((val, idx) => val === solution[idx]);
    }

    function shufflePuzzle() {
        let emptyIndex = puzzleState.indexOf(0);
        for (let i = 0; i < 100; i++) {
            const validMoves = getValidMoves(emptyIndex);
            const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
            [puzzleState[emptyIndex], puzzleState[randomMove]] = [puzzleState[randomMove], puzzleState[emptyIndex]];
            emptyIndex = randomMove;
        }
        moves = 0;
        document.getElementById('moveCount').textContent = moves;
        renderPuzzle();
    }

    function completePuzzle() {
        // Show loading
        document.getElementById('puzzle').style.opacity = '0.5';

        fetch('{{ url_for("minigames.slider_complete", challenge_id=challenge.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ state: puzzleState })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById('revealedPart').textContent = 'Key Part: ' + data.revealed_part;
                    document.getElementById('puzzle').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                } else {
                    alert('Error: ' + (data.message || 'Failed to complete puzzle'));
                    document.getElementById('puzzle').style.opacity = '1';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error completing puzzle: ' + error.message);
                document.getElementById('puzzle').style.opacity = '1';
            });
    }

    // Initial render
    renderPuzzle();
</script>
{% endblock %}